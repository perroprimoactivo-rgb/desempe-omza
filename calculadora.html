<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Bono por Desempeño</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Custom disabled styles */
        button:disabled {
            cursor: not-allowed;
            background-color: #a5b4fc; /* Lighter indigo */
            opacity: 0.7;
        }

        /* Responsive Table Styles */
        @media screen and (max-width: 767px) {
            .responsive-table thead {
                display: none;
            }
            .responsive-table tbody, .responsive-table tr {
                display: block;
                width: 100%;
            }
             .responsive-table tr {
                padding: 1rem 0;
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0.5rem;
                text-align: right;
                width: 100%;
                border-bottom: 1px solid #e5e7eb;
            }
             .responsive-table tr:last-child td:last-child {
                border-bottom: none;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                padding-right: 1rem;
            }
            .responsive-table .nota-input-cell {
                justify-content: space-between;
            }
            .responsive-table .nota-input {
                width: 5rem; /* Adjust width of note input on mobile */
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-4 md:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-2xl md:text-4xl font-bold text-indigo-600">Calculadora de Bono por Desempeño</h1>
            <p class="text-gray-500 mt-2 text-sm md:text-base">Ingresa el monto del fondo de estímulo y tus calificaciones para ver el resultado.</p>
        </header>
        
        <main>
            <!-- Section for Base Amount Input -->
            <div class="mb-8 p-4 md:p-6 bg-indigo-50 rounded-xl border border-indigo-200">
                <label for="montoBase" class="block text-lg font-semibold text-gray-700 mb-2">1. Monto del Fondo de Estímulo ($)</label>
                <p class="text-sm text-gray-500 mb-3">Coloca aquí el monto total del "ítem 1862 Componente Evaluación de Desempeño".</p>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">$</span>
                    <input type="number" id="montoBase" placeholder="Ej: 25000" required class="w-full pl-7 pr-4 py-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg">
                </div>
            </div>

            <!-- Section for Subfactor Evaluation -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">2. Evaluación de Subfactores</h2>
                <div class="overflow-x-auto bg-white rounded-xl border">
                    <table class="w-full text-left responsive-table">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-semibold">Subfactor (Orden Oficial)</th>
                                <th class="p-4 font-semibold text-center w-28">Ponderación</th>
                                <th class="p-4 font-semibold text-center w-36">Nota (1–5)</th>
                                <th class="p-4 font-semibold text-right w-48">Puntaje Ponderado</th>
                            </tr>
                        </thead>
                        <tbody id="tablaSubfactores" class="divide-y md:divide-y-0">
                            <!-- Rows will be generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Section for Results and Actions -->
            <div>
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Resultados Finales</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- Total Points -->
                    <div class="bg-gray-50 p-5 rounded-xl border text-center">
                        <p class="text-sm text-gray-500">Total Puntos</p>
                        <p id="totalPuntos" class="text-2xl font-bold text-indigo-600">0.00</p>
                    </div>
                    <!-- Compliance Percentage -->
                    <div class="bg-gray-50 p-5 rounded-xl border text-center">
                        <p class="text-sm text-gray-500">% Cumplimiento</p>
                        <p id="porcentajeCumplimiento" class="text-2xl font-bold text-indigo-600">0.00%</p>
                    </div>
                    <!-- Amount to Receive -->
                    <div class="bg-green-50 p-5 rounded-xl border border-green-200 text-center">
                        <p class="text-sm text-green-700">Monto a Cobrar ($)</p>
                        <p id="montoACobrar" class="text-2xl font-bold text-green-600">$0.00</p>
                    </div>
                    <!-- Discount -->
                    <div class="bg-red-50 p-5 rounded-xl border border-red-200 text-center">
                        <p class="text-sm text-red-700">Descuento ($)</p>
                        <p id="descuento" class="text-2xl font-bold text-red-600">$0.00</p>
                    </div>
                </div>
                
                <!-- Validation Message and Export Button -->
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-8">
                     <p id="validationMessage" class="text-red-600 text-sm font-medium text-center sm:text-left">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.22 3.006-1.742 3.006H4.42c-1.522 0-2.492-1.672-1.742-3.006l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        Por favor, completa todos los campos para continuar.
                     </p>
                     <button id="exportButton" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        Exportar a PDF
                    </button>
                </div>

            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;

            const subfactores = [
                { nombre: "a) Asistencia y Puntualidad", ponderacion: 10 },
                { nombre: "b) Cumplimiento de Funciones asignadas", ponderacion: 10 },
                { nombre: "a) Trato respetuoso y colaboración con el equipo", ponderacion: 6 },
                { nombre: "b) Participación activa en tareas del área", ponderacion: 6 },
                { nombre: "a) Manejo de herramientas, sistemas o normativas", ponderacion: 7 },
                { nombre: "b) Organización del trabajo e informes administrativos", ponderacion: 7 },
                { nombre: "a) Disposición al aprendizaje y adaptación a cambios organizativos", ponderacion: 7 },
                { nombre: "b) Propuestas o aportes de mejora a procesos administrativos", ponderacion: 7 }
            ];

            const tablaBody = document.getElementById('tablaSubfactores');
            const montoBaseInput = document.getElementById('montoBase');
            const validationMessage = document.getElementById('validationMessage');
            const exportButton = document.getElementById('exportButton');

            subfactores.forEach((factor, index) => {
                const row = document.createElement('tr');
                row.classList.add('md:hover:bg-gray-50');
                row.innerHTML = `
                    <td data-label="Subfactor" class="p-4 text-gray-600 font-medium">${factor.nombre}</td>
                    <td data-label="Ponderación" class="p-4 md:text-center text-gray-500">${factor.ponderacion}</td>
                    <td data-label="Nota (1–5)" class="p-4 nota-input-cell">
                        <input 
                            type="number" 
                            min="1" 
                            max="5" 
                            step="1" 
                            required
                            class="nota-input md:mx-auto text-center py-2 px-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" 
                            data-ponderacion="${factor.ponderacion}"
                            id="nota-${index}"
                        >
                    </td>
                    <td data-label="Puntaje Ponderado" class="p-4 md:text-right font-medium text-gray-800" id="puntaje-${index}">0.00</td>
                `;
                tablaBody.appendChild(row);
            });

            const notaInputs = document.querySelectorAll('.nota-input');

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
            };

            const checkAllFields = () => {
                let allFilled = true;
                if (!montoBaseInput.value || parseFloat(montoBaseInput.value) <= 0) {
                    allFilled = false;
                }
                notaInputs.forEach(input => {
                    if (!input.value) {
                        allFilled = false;
                    }
                });
                
                if(allFilled) {
                    validationMessage.classList.add('hidden');
                    exportButton.disabled = false;
                } else {
                    validationMessage.classList.remove('hidden');
                    exportButton.disabled = true;
                }
                return allFilled;
            };

            const calcularBono = () => {
                if (!checkAllFields()) {
                    // If fields are not complete, reset results to 0
                    document.getElementById('totalPuntos').textContent = '0.00';
                    document.getElementById('porcentajeCumplimiento').textContent = '0.00%';
                    document.getElementById('montoACobrar').textContent = formatCurrency(0);
                    document.getElementById('descuento').textContent = formatCurrency(0);
                    notaInputs.forEach((_, index) => {
                        document.getElementById(`puntaje-${index}`).textContent = '0.00';
                    });
                    return;
                }

                const montoBase = parseFloat(montoBaseInput.value) || 0;
                let totalPuntos = 0;

                notaInputs.forEach((input, index) => {
                    // Force integer and clamp between 1 and 5
                    let nota = 0;
                    if(input.value){
                        let notaInt = parseInt(input.value, 10);
                        nota = Math.max(1, Math.min(5, notaInt));
                        if(nota !== notaInt) input.value = nota; // auto-correct the input
                    }
                    
                    const ponderacion = parseFloat(input.dataset.ponderacion);
                    const puntajePonderado = (nota * ponderacion) / 5;
                    document.getElementById(`puntaje-${index}`).textContent = puntajePonderado.toFixed(2);
                    totalPuntos += puntajePonderado;
                });

                const maximoEscala = 60;
                const porcentajeCumplimiento = maximoEscala > 0 ? (totalPuntos / maximoEscala) : 0;
                const montoACobrar = montoBase * porcentajeCumplimiento;
                const descuento = montoBase - montoACobrar;

                document.getElementById('totalPuntos').textContent = totalPuntos.toFixed(2);
                document.getElementById('porcentajeCumplimiento').textContent = `${(porcentajeCumplimiento * 100).toFixed(2)}%`;
                document.getElementById('montoACobrar').textContent = formatCurrency(montoACobrar);
                document.getElementById('descuento').textContent = formatCurrency(descuento);
            };

            const exportarResultados = () => {
                if (!checkAllFields()) return;

                const doc = new jsPDF();
                const montoBase = parseFloat(montoBaseInput.value) || 0;
                let y = 15; // Vertical position tracker

                // Title
                doc.setFontSize(18);
                doc.text("Informe de Cálculo de Bono", 105, y, { align: 'center' });
                y += 10;
                doc.setLineWidth(0.5);
                doc.line(20, y, 190, y);
                y += 10;
                
                // Summary
                doc.setFontSize(12);
                doc.text("Resumen del Cálculo", 20, y);
                y += 7;
                doc.setFontSize(10);
                doc.text(`Fecha de Exportacion: ${new Date().toLocaleString('es-AR')}`, 20, y);
                y += 7;
                doc.text(`Monto del Fondo de Estimulo: ${formatCurrency(montoBase)}`, 20, y);
                y += 7;
                doc.text(`Total de Puntos Obtenidos: ${document.getElementById('totalPuntos').textContent}`, 20, y);
                y += 7;
                doc.text(`Porcentaje de Cumplimiento: ${document.getElementById('porcentajeCumplimiento').textContent}`, 20, y);
                y += 10;

                // Final amounts with emphasis
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`MONTO FINAL A COBRAR: ${document.getElementById('montoACobrar').textContent}`, 20, y);
                y += 7;
                doc.text(`DESCUENTO APLICADO: ${document.getElementById('descuento').textContent}`, 20, y);
                y += 10;
                doc.setFont('helvetica', 'normal');

                // Details section
                doc.setLineWidth(0.2);
                doc.line(20, y, 190, y);
                y += 10;
                doc.setFontSize(12);
                doc.text("Detalle de Evaluación por Subfactor", 20, y);
                y += 10;
                
                doc.setFontSize(10);
                subfactores.forEach((factor, index) => {
                    if (y > 270) { // Add new page if content overflows
                        doc.addPage();
                        y = 15;
                    }
                    const nota = document.getElementById(`nota-${index}`).value;
                    const puntaje = document.getElementById(`puntaje-${index}`).textContent;
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text(factor.nombre, 20, y);
                    y += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.text(`  - Nota Asignada: ${nota}`, 25, y);
                    y += 6;
                    doc.text(`  - Puntaje Ponderado: ${puntaje}`, 25, y);
                    y += 8;
                });

                doc.save('Resultados_Bono_Desempeno.pdf');
            };

            montoBaseInput.addEventListener('input', calcularBono);
            notaInputs.forEach(input => {
                input.addEventListener('input', calcularBono);
            });
            exportButton.addEventListener('click', exportarResultados);
            
            checkAllFields();
            calcularBono();
        });
    </script>
</body>
</html>

